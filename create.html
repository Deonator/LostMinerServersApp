<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
    }
    input, select, button {
      display: block;
      margin: 10px 0;
      padding: 10px;
      width: 300px;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #00aa00;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #444;
      cursor: not-allowed;
    }
    a {
      color: #00ffff;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <a href="index.html">‚Üê –ù–∞–∑–∞–¥</a>
  <h1>–°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä</h1>

  <div id="auth">
    <button id="loginBtn">üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  </div>

  <div id="form" style="display: none;">
    <p id="userInfo"></p>
    <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞">
    <input id="type" placeholder="–¢–∏–ø (PvP, RP...)">
    <input id="host" placeholder="–•–æ—Å—Ç (IP –∏–ª–∏ –∞–¥—Ä–µ—Å)">
    <input id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
    <select id="status">
      <option value="online">üü¢ –í–∫–ª—é—á–µ–Ω</option>
      <option value="offline">üî¥ –í—ã–∫–ª—é—á–µ–Ω</option>
    </select>
    <button id="createBtn">–°–æ–∑–¥–∞—Ç—å</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, push, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIRk2K83lNl0Pun1Kk7swyRGaEOWH6zj0",
      authDomain: "loststrahzcorporation.firebaseapp.com",
      databaseURL: "https://loststrahzcorporation-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "loststrahzcorporation",
      storageBucket: "loststrahzcorporation.firebasestorage.app",
      messagingSenderId: "802412818791",
      appId: "1:802412818791:web:e818386c7a6e6de2f7ffc2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const formDiv = document.getElementById("form");
    const authDiv = document.getElementById("auth");
    const userInfo = document.getElementById("userInfo");

    loginBtn.onclick = () => signInWithPopup(auth, provider).catch(alert);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authDiv.style.display = "none";
        userInfo.textContent = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${user.displayName} (${user.email})`;
        formDiv.style.display = "block";

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–µ—Ä–≤–µ—Ä –æ—Ç —ç—Ç–æ–≥–æ uid
        const serversRef = ref(db, "servers");
        const q = query(serversRef, orderByChild("uid"), equalTo(user.uid));
        const snapshot = await get(q);

        if (snapshot.exists()) {
          document.getElementById("createBtn").disabled = true;
          document.getElementById("createBtn").textContent = "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä";
        }

        document.getElementById("createBtn").onclick = async () => {
          const name = document.getElementById("name").value.trim();
          const type = document.getElementById("type").value.trim();
          const host = document.getElementById("host").value.trim();
          const desc = document.getElementById("desc").value.trim();
          const status = document.getElementById("status").value;

          if (!name || !type || !host) {
            alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ç–∏–ø –∏ —Ö–æ—Å—Ç!");
            return;
          }

          await push(ref(db, "servers"), {
            name,
            type,
            host,
            status,
            description: desc,
            uid: user.uid,
            email: user.email,
            displayName: user.displayName
          });

          alert("‚úÖ –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–Ω!");
          window.location.href = "index.html";
        };
      }
    });
  </script>
</body>
</html>
